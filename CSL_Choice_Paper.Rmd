---
header-includes: 
  - \thispagestyle{empty}
  - \usepackage{setspace}
  - \setstretch{2}
  - \AtBeginEnvironment{tabular}{\doublespacing}
  - \AtBeginEnvironment{lltable}{\doublespacing}
  - \AtBeginEnvironment{tablenotes}{\doublespacing}
  - \captionsetup[table]{font={stretch=1.5}}
  - \captionsetup[figure]{font={stretch=1.5}}
  - \usepackage{booktabs}

title             : "Selection history guides attention even when top-down control is maximised"
shorttitle        : "Selection history under top-down control"

author: 
  - name          : "Dion T. Henare"
    affiliation   : "1"
    corresponding : yes
    address       : "Gutenbergstraße 18, 35032 Marburg"
    email         : "dion.henare@uni-marburg.de"
  - name          : "Hanna Kadel"
    affiliation   : "1"
  - name          : "Anna Schuboe"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "Philipps-University of Marburg, Germany"

author_note: |
  Funded by the Deutsche Forschungsgemeinschaft (DFG, German Research Foundation) – project number 222641018 – SFB/TRR 135 TP B3

abstract: |
  - abstract text -

bibliography      : ["cslChoice_references.bib"]

figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : no
mask              : no

numbersection     : no
class             : "man"
output            : papaja::apa6_word

---

\raggedbottom

```{r setup, include=FALSE}
set.seed(4609948)
library(knitr)
opts_chunk$set(echo = FALSE)

library(tidyr)
library(dplyr)
library(ggplot2)
library(afex)
library(cowplot)
library(papaja)
library(png)
library(grid)
library(emmeans)
library(gridExtra)
#colour, grey, center, categorisation, lateralisation, distractor
```

```{r helperfunctions}
annotation_custom2 <- 
function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data){ layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))}
#Function for making split violin option in ggplot
GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin, 
                           draw_group = function(self, data, ..., draw_quantiles = NULL) {
                             data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
                             grp <- data[1, "group"]
                             newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
                             newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
                             newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])
                             
                             if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
                               stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <=
                                                                         1))
                               quantiles <- ggplot2:::create_quantile_segment_frame(data, draw_quantiles)
                               aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
                               aesthetics$alpha <- rep(1, nrow(quantiles))
                               both <- cbind(quantiles, aesthetics)
                               quantile_grob <- GeomPath$draw_panel(both, ...)
                               ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
                             }
                             else {
                               ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
                             }
                           })

geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
                              draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
                              show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, 
        position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
        params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}

### This script creates an R function to generate raincloud plots, then simulates
### data for plots. If using for your own data, you only need lines 1-80.
### It relies largely on code previously written by David Robinson
### (https://gist.github.com/dgrtwo/eb7750e74997891d7c20)
### and the package ggplot2 by Hadley Wickham

# Check if required packages are installed ----
packages <- c("cowplot", "readr", "ggplot2", "dplyr", "lavaan", "smooth", "Hmisc")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))
}

# Load packages ----
library(ggplot2)

# Defining the geom_flat_violin function ----
# Note: the below code modifies the
# existing github page by removing a parenthesis in line 50

"%||%" <- function(a, b) {
  if (!is.null(a)) a else b
}

geom_flat_violin <- function(mapping = NULL, data = NULL, stat = "ydensity",
                             position = "dodge", trim = TRUE, scale = "area",
                             show.legend = NA, inherit.aes = TRUE, ...) {
  layer(
    data = data,
    mapping = mapping,
    stat = stat,
    geom = GeomFlatViolin,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      trim = trim,
      scale = scale,
      ...
    )
  )
}

#' @rdname ggplot2-ggproto
#' @format NULL
#' @usage NULL
#' @export
GeomFlatViolin <-
  ggproto("GeomFlatViolin", Geom,
          setup_data = function(data, params) {
            data$width <- data$width %||%
              params$width %||% (resolution(data$x, FALSE) * 0.9)
            
            # ymin, ymax, xmin, and xmax define the bounding rectangle for each group
            data %>%
              group_by(group) %>%
              mutate(
                ymin = min(y),
                ymax = max(y),
                xmin = x,
                xmax = x + width / 2
              )
          },
          
          draw_group = function(data, panel_scales, coord) {
            # Find the points for the line to go all the way around
            data <- transform(data,
                              xminv = x,
                              xmaxv = x + violinwidth * (xmax - x)
            )
            
            # Make sure it's sorted properly to draw the outline
            newdata <- rbind(
              plyr::arrange(transform(data, x = xminv), y),
              plyr::arrange(transform(data, x = xmaxv), -y)
            )
            
            # Close the polygon: set first and last point the same
            # Needed for coord_polar and such
            newdata <- rbind(newdata, newdata[1, ])
            
            ggplot2:::ggname("geom_flat_violin", GeomPolygon$draw_panel(newdata, panel_scales, coord))
          },
          
          draw_key = draw_key_polygon,
          
          default_aes = aes(
            weight = 1, colour = "grey20", fill = "white", size = 0.5,
            alpha = NA, linetype = "solid"
          ),
          
          required_aes = c("x", "y")
  )
```

# Introduction

Everyday visual scenes contain far more information than the human visual system can process at a given point in time. Effective functioning in spite of this limitation requires a system which can flexibly focus its processing on the most relevant parts of a scene. Historically, models of this process have posited that selection is driven by the interaction between bottom-up and top-down influences. Bottom-up processes are based on the physical properties of a stimulus, biasing selection toward things like bright, flashing lights and loud, sudden noises. Top-down processes on the other hand are based on the internal goals of the individual, biasing selection toward, for example, the red and white hat worn by a friend that you’ve lost in a crowd. More recently, @awh2012top suggested that a third factor, selection history, is integrated with both top-down and bottom-up information in order to guide attention in a visual scene.

Selection history refers to an individual’s previous experience of encountering and responding to a stimulus in a given context [@awh2012top], and a range of experiments have provided evidence of its impact on attention. One such example of how selection history impacts on the deployment of attention is demonstrated by intertrial priming. In visual search tasks where target features vary from trial to trial, intertrial priming refers to the observation that participants respond significantly faster to the current target when it matches the features of the target from the preceding trial [@fecteau2007priming;@nakayama2004short;@maljkovic1994priming;@wolfe2003changing]. Notably, features associated with a previous trial’s target are primed even in cases where they contradict the current top-down goals of the participant [@maljkovic1994priming]. It has also been shown that associating a stimulus with reward can produce increased attentional capture by that stimulus long after the reward has stopped [@laurent2015valuable;@wang2018stimuli;@hickey2013reward;@donohue2016rapid]. Similarly, subtle statistical regularities in target and distractor location across a task have been demonstrated to produce implicit changes in the efficiency of both target selection and distractor suppression processes [@ferrante2018altering;@wang2018statistical;@failing2019spatial]. Intertrial priming, reward association, and statistical learning all demonstrate the critical role that selection history plays alongside bottom-up and top-down influences on attentional control.

The impact that selection history has on the allocation of attention has also been shown to persist even when participants are performing a different task. @feldmann2015you demonstrated this using a dual task paradigm in which participants performed either a categorisation task or a search task on each trial. During the categorisation task, participants learned to categorise stimuli based on either colour or shape, while in the search task they searched for a shape singleton and responded to the rotated line that it contained. Their results showed that when colour distractors were present in the search displays, they caused greater interference for participants who had performed colour categorisation in the categorisation task. This implies that colour became more salient as a result of selection history, and follow-up experiments showed that these effects persist when the tasks are performed in separate blocks, and on separate days [@kadel2017selection].

Additional insight into the effect of selection history on attention has been provided through the measurement of neural indices of attention processing recorded by EEG. One of the predominant components used to study attention is an enhanced negativity recorded at posterior electrode sites contralateral to an attended stimulus, occurring approximately 200ms after stimulus onset. Referred to as N2pc, this component is generally considered to reflect the deployment of spatially selective attention to the stimulus [@grubert2016all;@luck1994spatial;@luck1994electrophysiological;@li2018further], and has been used as an index of attentional capture by relevant stimuli [@kiss2008n2pc;@berggren2018object;@mccants2018guidance] and pop-out objects [@eimer2007attentional;@holguin2009n2pc]. In their dual task investigation into the effects of selection history on attention, @feldmann2015you showed that during search trials, participants who had performed colour categorisation in the categorisation task produced an N2pc to the colour distractor whereas participants who performed shape categorisation did not. These data support the suggestion that selection history results in the automatic allocation of attention to stimuli even when they are currently task irrelevant.

Recently, methodological developments have allowed for even more specific measures of attention processing using EEG. Efficient attentional orienting depends not only on efficient mechanisms for identifying and orienting to targets, but also the identification and suppression of possible distractors. Distinguishing between these processes using only behavioural measures can be difficult, however, recent research has identified a set of lateralised event-related potentials that can provide dissociable measures of object selection and suppression. Central to the calculation of the N2pc is the subtraction of any neural activity that is represented equally in both hemispheres. @hickey2009electrophysiological took advantage of this fact in order to dissociate target and distractor processing. Participants in their task performed a visual search task in which both a target and distractor were present, but only one of these objects was lateralised on a given trial. When a target is lateralised and the distractor is on the midline, calculation of lateralised ERPs results in subtraction of all distractor activity and isolation of lateralised target processing. Similarly, when the distractor is lateralised, activity related to distractor processing can be isolated. Results using this approach have identified an early lateralised negativity indexing the attentional selection of a stimulus, and a later lateralised positivity reflecting attentional disengagement from a stimulus [@hickey2009electrophysiological].

Specific measures of attentional selection and suppression have provided increased specificity of the role that selection history plays in the orienting of attention. In a follow-up experiment @feldmann2015you adapted their task in order to allow for the dissociation of target and distractor processing. Their results showed that for participants who categorised based on colour in the categorisation task, the presentation of a coloured distractor in the search task elicited an ND (a lateralised negativity to distractors) followed by a relatively large PD (a lateralised positivity to distractors). This implies that for these participants, the colour distractor captured attention in the search task (reflected by ND) and therefore required increased subsequent suppression (reflected by increased PD). Participants who had learned to categorise based on shape however did not show this effect. The colour distractor in their case elicited no ND during search trials and a small PD, indexing a lack of attentional capture and decreased distractor suppression respectively.

An open question remains as to whether increased top-down control can be used to attenuate, or eliminate the effects of selection history on attention. Previously, dual task investigations of the effect have attempted to enhance top-down control processes by providing cues to participants which inform them of which task they’re about to perform [@kadel2017selection]. While this allows participants to switch task sets in preparation for the upcoming trial, the effect of selection history on attention has remained suggesting that top-down control cannot be used to override the effects of selection history. However, recent work has suggested that these cues are insufficient for allowing participants to optimally engage top-down control before the trial begins [@kiesel2010control]. A novel approach to increasing top-down attentional control in dual tasks is the voluntary task-switching paradigm developed by @arrington2004cost. In this version of the task, participants are not cued as to what trial type will be performed next, but rather they are given the choice of which trial type they would like to perform next. Evidence suggests that the voluntary task switching paradigm allows for stronger proactive control over performance of each task [@arrington2005voluntary;@kang2014electrophysiological].

Another advantage of voluntary task selection procedures is that the allow us to measure choice processes and could therefore provide insight into how this is affected by selection history. In previous use of voluntary task selection, research has shown that while participants are instructed to perform the two tasks in a random order, there are systematic patterns in task selection. Participants in these tasks typically show a repetition bias in their task choices [@arrington2004cost] which is exacerbated by shorter intertrial intervals [@arrington2005voluntary;@vandierendonck2010task], and typically involves a preference for performing the more difficult task [@millington2013between;@yeung2010bottom]. A number of previous studies have also shown that the availability of a stimulus to the cognitive system can impact task choice [@mayr2006unpredictable;@yeung2010bottom;@arrington2010stimulus]. For example, when participants choose to perform either size or animacy judgements about words, their choice is affected by the judgement they performed on that word in an earlier phase of the experiment [@arrington2010stimulus]. Similarly, there are consistent biases in judgement choice across participants in which particular words are more likely to elicit a particular judgement choice (eg. people are more likely to perform size judgements on the word "asprin") [@arrington2010stimulus]. In other voluntary selection tasks, repetition of a target's location has increased the likelihood of a participant repeating their previous choice [@mayr2006unpredictable;@yeung2010bottom], and individual switch rates correlated strongly with the cost of a task switch[@mayr2006unpredictable]. These findings suggest that previous history impacts on the ease with which a particular task can be performed and therefore in turn, impacts task choice in a voluntary selection paradigm. 

In the present study, we adapted the design of @feldmann2015you to a voluntary task switching paradigm in order to investigate the relationship between top-down control and selection history. By allowing participants to determine whether they would perform search or categorisation on the next trial, participants would be able to proactively engage the task set for the upcoming trial and exercise maximal top-down control. We also recorded EEG during their performance of the task and leveraged the procedure of @hickey2009electrophysiological to allow for the isolation of target and distractor activity. This approach provides specific measures of target selection, distractor capture, and distractor suppression during the task, and therefore provides a fine grained understanding of how top-down control interacts with selection history during attentional orienting. If increased top-down control is able to eliminate the effects of selection history, then we would expect to see distractor costs in the search task to be similar regardless of whether participants were assigned to the shape or colour group in the categorisation task. We would also expect that group assignment would not have differential effects on the lateralised ERP components elicited by stimuli in the search task. On the other hand, if top-down control cannot be used to override selection history effects then the effect of categorisation group assignment on distractor costs and ERP component amplitudes during search should remain.

# Methods

## Participants

27 participants with normal or corrected-to-normal vision (tested using an Oculus Binoptometer 3) participated in the task for either payment or course credit. All participants gave written and informed consent prior to the start of the experiment. Participants were randomly assigned to either the shape group (ages ranging from 21 to 31, mean = 24.5, SD = 2.8) or the colour group (ages ranging from 19 to 25, mean = 22.5, SD = 1.7). Each group had one left handed participant and all other participants were right handed. One participant did not reach suitable performance during the practice session and was therefore excluded from the experiment.

## Experimental procedure

Participants came in for two separate sessions and performed two different tasks within each session, a categorisation task and a search task (described in detail below). In session one, participants were familiarised with the two tasks by performing them in separate blocks. In session two, the full task began where participants chose at the start of each trial whether they would perform a categorisation or search trial. Participants were seated in a comfortable chair in a dimly lit room with their eyes 100cm away from the screen (LCD-TN Samsung Syncmaster 2233). An Erogodex DX1 response pad was placed on their lap with 6 keys arranged so that participants could use the index and middle finger of each hand to respond to the task, while the thumb on each hand could be used to perform task selection between trials. Stimulus presentation and response collection was controlled by E-Prime 2.0 and audio feedback was presented by two stereo speakers (Logitech Z120 2.0) placed behind the screen.

### Stimuli

Each stimulus presented during the categorisation and search trials was presented on a dark grey background and subtended 2.3 degrees of visual angle. A fixation cross (0.6 degrees) was located in the centre of the screen throughout the experiment in order to help participants maintain central fixation. The physical luminance of the grey, green, blue, and red stimulus colours was balanced using a luminance meter (Konica Minolta LS-100). Examples of the stimulus displays for each task are shown in figure\ \@ref(fig:stimDisplays).

(ref:stimDispFig) Example stimulus displays for the categorisation (A) and search tasks (B). In each display, one singleton is lateralised and the other is on the midline in order to allow for the calculation of EEG activity elicited by the lateral stimulus. Participants performed 1152 trials in total, 50% of these were required to be categorisation trials (half of each display type) and 50% were required to be search trials (one third of each display type).

```{r stimDisplays, fig.cap = "(ref:stimDispFig)"}
include_graphics("Figures/CSL-Choice trial displays.jpg")
```

### Categorisation trials

Categorisation trials began with a 500 ms fixation cross in the center of the screen. Eight stimuli were then presented simultaneously in a circular arrangement with a radius of 6.3 degrees of visual angle for 200 ms, six of these objects were unfilled grey circles, one was an unfilled coloured circle (either blue or green randomly selected on each trial), and one was an unfilled grey shape singleton (either pentagon or triangle selected randomly on each trial). The colour singleton and the shape singleton were constrained to appear in only four of the eight possible locations along either the vertical or horizontal midline. In half of the categorisation trials (288 trials), the shape singleton was presented on one of the vertical midline positions while the colour singleton was presented on one of the lateral positions on the horizontal midline. In the other half of categorisation trials the colour singleton was on the vertical midline while the shape singleton was lateralised (see figure\ \@ref(fig:stimDisplays)). Participants had two response keys for the categorisation task and after selecting one of these keys, they were given feedback informing them whether they had selected the correct response. At the beginning of the task, participants were not told the correct stimulus reponse pairing and instead had to learn which key was correct for a given display. For half of the participants (the colour group) the correct response was based on the colour singleton (eg. key 1 when blue was shown, key 2 when green was shown). For the other half of participants (the shape group) the correct response was based on the shape singleton (eg. key 1 when a pentagon was shown, key 2 when a triangle was shown).The trial would end when particpants made their response, up to a maximum of 2000 ms.

### Search trials

Search trials began with a 500 ms fixation cross in the center of the screen. Eight stimuli were then presented simultaneously in a circular arrangement with a radius of 6.3 degrees of visual angle for 200 ms, six of these were always unfilled grey circles, and one was the target - an unfilled grey diamond. The final stimulus was either another unfilled grey circle (in the target only condition) or an unfilled red circle (in the distractor present condition). Each of these stimuli contained a straight line of varying orientations and participants were required to indicate whether the line contained by the target diamond was oriented horizontally or vertically. The trial would end when particpants made their response, up to a maximum of 2000 ms. One third of the search trials (192 trials) were target only trials were the circular display contained 7 grey circles and one grey diamond target. The other two thirds of the search trials were distractor present trials where one of the circles was coloured red. In half of these distractor present search trials (192 trials), the target diamond was placed on the vertical midline and the coloured distractor was lateralised to either the left or right (chosen randomly on each trial) along the horizontal midline. In the remaining trials (192 trials) the coloured distractor was placed on the vertical midline and the target diamond was lateralised to either the left or right (chosen randomly on each trial) on the horizontal midline (see figure\ \@ref(fig:stimDisplays)).

### Task selection

In session two, every trial began with a task selection screen where participants had to indicate using either their left or right thumbs, whether they would like to perform a categorisation or search trial. This screen stayed on until the participant response. Participants were asked to try to ensure that they distributed their choices evenly between the two options, and to try and make their choice random and unpredictable. Participants were required to perform 576 of each trial type and after every block of 32 trials, participants were shown a pictoral display indicating how many of each trial type was left for them to perform as well as some feedback about response times and accuracy. Examples of the full trial procedure and a between block feedback display are shown in figure\ \@ref(fig:trialProc).

(ref:trialProcFig) Figure showing the trial procedure (A) where participants started each trial by selecting which of two tasks they would perform next. After a 500ms delay, their chosen task display was presented. In the case of a categorisation dosplay they would categorise eithe rthe shape of colour singleton (depending on group assignment) whereas in the search task all participants would respond to the orientation of the line within the shape singleton. An example of the feedback display (B) shown to participants between blocks which provides information about the percentage of trials left for each task, as well as the number of blocks completed, average accuracy for each task, and average response time for each task.

```{r trialProc, fig.cap = "(ref:trialProcFig)"}
include_graphics("Figures/CSLChoice Trial Proc and interblock feedback.jpg")
```

## EEG recording

EEG activity was recorded continuously at 1000Hz using Brain Products 64 channel actiCAP Ag/AgCl electodes.The electrodes were arranged according to the modified combinatorial nomenclature (MCN) for the 10-10 system. The online reference was FCz and the COM sensor was located on the z axis between FCz and Cz. EEG activity was preamplified by the active electrodes and then passed to a brain products brainamp amplifier with 16 bit A/D conversion, an input impedance of 10MOhms, and an antialiasing filter with a 1000Hz low pass cut off. Impedances were kept below 5kOHms and active shielding was used throughout for attenuating common mode noise.

## EEG processing

EEG data were processed using the EEGLAB toolbox in MATLAB. First, data were segmented into 700ms epochs (-200 to 500ms around each search or categorisation display) and baselined so that the average of the prestimulus period was set to zero for each event. For artifact rejection a HEOG channel was created by taking the voltage difference between the electrodes on the outer canthi of each eye, and a VEOG was created by taking the voltage difference between the electrodes above and below the left eye. These channels were filtered using a lowpass value of 35Hz in order to reduce false positives, and then trials containing either +/- 35mV in the HEOG channel (within 300ms post stimulus presentation) or +/- 80mV in the VEOG channel were removed. Trials containing +/- 80mv in the channels of interest (PO3, PO7, PO4, and PO8) were also removed and the data were referenced to the average of all channels. Left hemisphere channels (PO3,PO7) were averaged together, and right hemisphere channels (PO4,PO8) were averaged together so that contralateral and ipsilateral ERPs could be calculated for each condition.

## Statistical analysis

### Selection history

#### Behavioural analyses

For behavioural analyses we removed any participant whose switch rate was below 0.2 (resulting in the removal of 3 participants), and we removed trials with abnormally long reaction times (greater than 2.5 standard deviations above the mean, calculated separately for each participant and each task) resulting in the removal of an average of 2.32% of trials in each task. For analyses where response time is the dependent variable, we also removed trials with incorrect responses resulting in the removal of a further 4.86% of the total categorisation trials and 4.51% of total search trials.

#### ERP analyses

For the categorisatoin task, participants were excluded if less than 70% of the trials remained in the categorisation task (equivalent to an average of 202 trials remaining in each condition) or if their switch rate between the tasks was less than 0.2 resulting in 4 exclusions. Our analyses focused on two components of intereste, the NT and PD. In order to determine the time range for the NT, a grand average ERP of all participants was created for lateralised predictor trials (colour singleton for colour group participants and shape singleton for shape participants). We found the peak negativity that ocurred later than 200ms poststimulus onset, and centred a 50ms time window on this timepoint producing a window from 206 to 256ms. For the PD component, we created a grand average ERP for lateralised non-predictor trials (the shape singleton for the colour group and the colour singleton for the shane group), identified the peak positivity that occurred later than 200ms poststimulus and centred a 50ms window on this timepoint which produced a window from 237 to 287ms.

For the search task, trials without a lateralised stimulus were removed, and participants were excluded if less than 85% of trials remained in the search task after artifact rejection (equivalent to an average of 163 trials remaining in each condition) or if their switch rate between the tasks was less than 0.2 resulting in 5 exclusions. We again focussed our analyses on the NT and PD components. To select the NT time window we created a grand average of all participants for trials with a lateralised target, identified the peak negativity that occurred later than 200ms poststimulus and centred a 50ms window on this time point. This produced a time range of 

### Voluntary task selection

To evaluate the choice processes in our task we used both switch rates and switch costs. For all of these analyses we applied the same rejection criteria as we used in the behavioural analyses presented above. Switch rate was calculated simply as the percentage of trials in which a participant chose to switch between the two tasks across the experiment. Switch costs were calculated as the average reposnse time difference between switch trials and repetition trials across the experiment.

# Results
```{r exclusion criteria}
minSwitchRate = 0.2
```

## Selection History

### Behavioral performance

```{r loadBehavData}
groupInfo = read.csv(file="BehaviouralData.csv")
#Load all data
behavData = read.csv(file="Behaviour/CSL_Choice_behav.csv")
behavData <- select(behavData,-c(ExperimentName, Session, Clock.Information, DataFile.Basename, Display.RefreshRate, ExperimentVersion, RandomSeed, RuntimeCapabilities, RuntimeVersion, RuntimeVersionExpected, SessionDate, SessionStartDateTimeUtc, SessionTime, StudioVersion,BlockAccC, BlockAccL, BlockRTC, BlockRTL, Group, pos1, pos2, pos3, pos4, pos5, pos6, pos7, pos8, Response.DurationError, Response.OnsetDelay, Response.OnsetTime, Response2.DurationError, Response2.OnsetDelay, Response2.OnsetTime)
)
```

```{r , include=FALSE}

for (sub in unique(behavData$Subject)) {
  behavData$Group[behavData$Subject==sub] = groupInfo$Group[groupInfo$Subject==sub]
  behavData$switchRate[behavData$Subject==sub] = groupInfo$SwitchRate[groupInfo$Subject==sub]
  behavData$compSD[behavData$Subject==sub] = sd(filter(behavData,Subject ==sub, Procedure.Trial. == "TaskC")$CompSearch.RT)
  behavData$compMean[behavData$Subject==sub] = mean(filter(behavData,Subject ==sub, Procedure.Trial. == "TaskC")$CompSearch.RT)
  behavData$learnSD[behavData$Subject==sub] = sd(filter(behavData,Subject ==sub, Procedure.Trial. == "TaskL")$LearnSearch.RT)
  behavData$learnMean[behavData$Subject==sub] = mean(filter(behavData,Subject ==sub, Procedure.Trial. == "TaskL")$LearnSearch.RT)
}
behavData$compCutoff <- behavData$compMean + (behavData$compSD * 2.5)
behavData$learnCutoff <- behavData$learnMean + (behavData$learnSD * 2.5)
behavData <- behavData %>% 
  mutate(SwitchCount = ifelse(repswitch=="switch",1,0))
behavData$Trial <- behavData$Block
behavData$Block <- trunc(unique(behavData$Block)/32-0.00001)+1

#Subject group table
behavData %>% 
  group_by(Subject) %>%
  summarise(Group = mean(Group))
behavData = behavData %>% mutate(Group = ifelse(Group==1,"Colour","Shape"))
behavData$Group = as.factor(behavData$Group)

#Save switch rates for ERP
switchRates <- behavData %>% group_by(Subject) %>%summarise(SR = mean(switchRate))
ParticipantsRejected <- unique(behavData %>% filter(switchRate < minSwitchRate) %>% group_by(Subject) %>% summarise(new = mean(Subject)))$new
```

```{r, include = FALSE}
autoCor <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(autoCor) <- c("Cor", "Subject", "Group")

for (subj in unique(behavData$Subject)) {
sData <- behavData %>% filter(Subject == subj)
Cor <- acf(sData$SwitchCount,lag.max = 576,plot = TRUE)$acf
Cor = data.frame(Cor)
Cor$Subject = subj
Cor$Group = behavData$Group[behavData$Subject==subj][1]
autoCor <- rbind(autoCor,Cor[])
}

autoCor$Cor <- sqrt(autoCor$Cor^2)

autoCor %>%
  filter(Cor < 1) %>%
  group_by(Subject,Group) %>%
  summarise(Cor = mean(Cor))
t.test(autoCor$Cor[autoCor$Group=="Colour"],autoCor$Cor[autoCor$Group=="Shape"], paired = FALSE)
```

```{r perfByTaskStats, include = FALSE}
#documenting trial rejection
alltrials <- behavData %>%
  filter(switchRate>minSwitchRate) %>%
  mutate(Acc = ifelse(is.na(LearnSearch.ACC), CompSearch.ACC, LearnSearch.ACC), Tcount = Acc+1-Acc) %>%
  group_by(Subject, Group, Procedure.Trial.) %>%
  summarise(Accuracy = sum(Tcount))
survabrej <- behavData %>%
  filter(switchRate>minSwitchRate,LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  mutate(Acc = ifelse(is.na(LearnSearch.ACC), CompSearch.ACC, LearnSearch.ACC), Tcount = Acc+1-Acc) %>%
  group_by(Subject, Group, Procedure.Trial.) %>%
  summarise(Accuracy = sum(Tcount))
survallrej <- behavData %>%
  filter(switchRate>minSwitchRate,LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff,LearnSearch.ACC==1 | CompSearch.ACC==1) %>%
  mutate(Acc = ifelse(is.na(LearnSearch.ACC), CompSearch.ACC, LearnSearch.ACC), Tcount = Acc+1-Acc) %>%
  group_by(Subject, Group, Procedure.Trial.) %>%
  summarise(Accuracy = sum(Tcount))
alltrials = cbind(alltrials,two = survabrej$Accuracy,three = survallrej$Accuracy)
alltrials %>%
  mutate(twoPerc = (Accuracy-two)/Accuracy*100, threePerc = (two - three)/Accuracy*100) %>%
  group_by(Procedure.Trial.) %>%
  summarise(twomean = mean(twoPerc), threemean = mean(threePerc))

acc <- behavData %>%
  filter(switchRate>minSwitchRate, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  mutate(Acc = ifelse(is.na(LearnSearch.ACC), CompSearch.ACC, LearnSearch.ACC)) %>%
  group_by(Subject, Group, Procedure.Trial.) %>%
  summarise(Accuracy = mean(Acc)*100)
acc.stat <- aov_ez(
  data = acc,
  dv = "Accuracy",
  id = "Subject", 
  within = c("Procedure.Trial."),
  between = "Group"
)
acc.res <- apa_print(acc.stat)
group.acc <- acc %>%
  group_by(Group) %>%
  summarise(mean = mean(Accuracy), se = sqrt(sd(Accuracy)/length(unique(Subject))))
task.acc <- acc %>%
  group_by(Procedure.Trial.) %>%
  summarise(mean = mean(Accuracy), se = sqrt(sd(Accuracy)/length(unique(Subject))))

rt <- behavData %>%
  filter(switchRate>minSwitchRate, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, LearnSearch.ACC==1 | CompSearch.ACC==1) %>%
  mutate(RT = ifelse(is.na(LearnSearch.RT), CompSearch.RT, LearnSearch.RT)) %>%
  group_by(Subject, Group, Procedure.Trial.) %>%
  summarise(RT = mean(RT))
rt.stat <- aov_ez(
  data = rt,
  dv = "RT",
  id = "Subject", 
  within = c("Procedure.Trial."),
  between = "Group"
)
rt.res <- apa_print(rt.stat)
group.rt <- rt %>%
  group_by(Group) %>%
  summarise(mean = mean(RT), se = sqrt(sd(RT)/length(unique(Subject))))
task.rt <- rt %>%
  group_by(Procedure.Trial.) %>%
  summarise(mean = mean(RT), se = sqrt(sd(RT)/length(unique(Subject))))
```

A 2x2 ANOVA was carried out in order to evaluate whether there were effects of group (shape vs colour) and task (categorisation vs search) on participant response times. The results showed that response times of participants in the shape group (M = `r as.character(round(group.rt$mean[2],2))`ms, se = `r as.character(round(group.rt$se[2],2))`) were not significantly different from participants in the colour group (`r paste("M = ", as.character(round(group.rt$mean[1],2)), "ms, se = ", as.character(round(group.rt$se[1],2)), ", " ,rt.res$full_result$Group, sep = "")`). However, participants in both groups perform significantly faster in the categorisation task (M = `r as.character(round(task.rt$mean[1],2))`ms, se = `r as.character(round(task.rt$se[1],2))`) than they do in the search task (`r paste("M = ", as.character(round(task.rt$mean[2],2)), "ms, se = ", as.character(round(task.rt$se[2],2)), ", " ,rt.res$full_result$Procedure_Trial_, sep = "")`). We do not observe a significant interaction between group and task (`r rt.res$full_result$Group_Procedure_Trial_`).

A 2x2 ANOVA was also carried out in order to evaluate whether there were effects of group and task on participant accuracy. The results did not show any significant effects of either group (`r acc.res$full_result$Group`) or task (`r acc.res$full_result$Procedure_Trial_`) on accuracy, nor any significant interaction between the two (`r acc.res$full_result$Group_Procedure_Trial_`).

#### Search task distraction

```{r, SearchStats}
searchAcc <- behavData %>%
  filter(Procedure.Trial. == "TaskC",switchRate>minSwitchRate, CompSearch.RT < compCutoff) %>%
  group_by(Subject, TrialType, Group) %>%
  summarise(Accuracy = mean(CompSearch.ACC)*100)
searchAcc.aov <- aov_ez(
  data = searchAcc,
  dv = "Accuracy",
  id = "Subject", 
  within = c("TrialType"),
  between = "Group"
)
searchAcc.res <- apa_print(searchAcc.aov)
group.sacc <- searchAcc %>%
  group_by(Group) %>%
  summarise(mean = mean(Accuracy), se = sqrt(sd(Accuracy)/length(unique(Subject))))
task.sacc <- searchAcc %>%
  group_by(TrialType) %>%
  summarise(mean = mean(Accuracy), se = sqrt(sd(Accuracy)/length(unique(Subject))))

searchRT <- behavData %>%
  filter(Procedure.Trial. == "TaskC",switchRate>minSwitchRate, CompSearch.ACC==1, CompSearch.RT < compCutoff) %>%
  group_by(Subject, TrialType, Group) %>%
  summarise(RT = mean(CompSearch.RT))
searchRT.aov <- aov_ez(
  data = searchRT,
  dv = "RT",
  id = "Subject", 
  within = c("TrialType"),
  between = "Group"
)
searchRT.res <- apa_print(searchRT.aov)
searchRT.fup <- apa_print.emmGrid(pairs(emmeans(searchRT.aov, ~TrialType|Group)))
group.srt <- searchRT %>%
  group_by(Group) %>%
  summarise(mean = mean(RT), se = sqrt(sd(RT)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"ms, se = ", as.character(round(se,2)), sep = ""))
task.srt <- searchRT %>%
  group_by(TrialType) %>%
  summarise(mean = mean(RT), se = sqrt(sd(RT)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"ms, se = ", as.character(round(se,2)), sep = ""))
intr.srt.mean <- searchRT %>%
  group_by(Group,TrialType) %>%
  summarise(mean = mean(RT)) %>%
  spread(TrialType, mean) %>%
  mutate(rtDiff = TD-Tonly, text = paste("$\\Delta M = ", as.character(round(rtDiff,2)), sep=""))
intr.srt.se <- searchRT %>%
  spread(TrialType, RT) %>%
  mutate(seDiff = TD-Tonly) %>%
  group_by(Group) %>%
  summarise(se = sqrt(sd(seDiff)/length(unique(Subject))))
intr.srt.text <- paste( intr.srt.mean$text, "ms, se = ", as.character(round(intr.srt.se$se, 2)),"$", sep ="")

distCost <- behavData %>%
  filter(Procedure.Trial. == "TaskC",switchRate>minSwitchRate, CompSearch.ACC==1, CompSearch.RT < compCutoff) %>%
  group_by(Subject, TrialType, Group) %>%
  summarise(RT = mean(CompSearch.RT)) %>%
  spread(TrialType, RT) %>%
  mutate(DistInt = TD-Tonly, GroupNum = as.integer(Group))
t.out = t.test(distCost$DistInt[distCost$Group == "Colour"],distCost$DistInt[distCost$Group == "Shape"])
intEffectTTest = apa_print(t.out)
```

For the search task, we used a mixed 2x2 ANOVA where trial type (target only vs target and distractor) was the within-subjects factor, and group (colour vs. shape) was the between-subjects factor. This was performed once with response time as the dependent variable and once with accuracy as the dependent variable.

Across both trial types, the colour group's response times (`r group.srt$text[1]`) do not differ significantly from participants in the shape group (`r paste(group.srt$text[2], " ", searchRT.res$full_result$Group,sep="")`), however participants in both groups do appear to respond significantly faster in the distractor absent trials (`r task.srt$text[2]`) than in the distractor present trials (`r paste(task.srt$text[1], " ", searchRT.res$full_result$TrialType,sep="")`). An interaction between trial type and group demonstrates that distractor presence has a significantly larger effect on participants in the colour group (`r intr.srt.text[1]`) than those in the shape group (`r paste(intr.srt.text[2], " ", searchRT.res$full_result$Group_TrialType, sep ="")`). This effect of group assignment on distractor cost is shown in figure\ \@ref(fig:DistIntViolin).

When it comes to search task accuracy we do not observe any differences as a result of either group (`r gsub("= .000\\$", "< .001\\$",gsub("= 0.00\\$","< 0.01\\$", searchAcc.res$full_result$Group))`) or trial type (`r gsub("= .000\\$", "< .001\\$",gsub("= 0.00\\$","< 0.01\\$",searchAcc.res$full_result$TrialType))`), nor any interaction between the two (`r searchAcc.res$full_result$Group_TrialType`).

```{r }
#Follow-up tests reveal that participants respond significantly slower when a distractor is present in the search display, and this is true in both the colour group (`r searchRT.fup$full_result$TD_Tonly_Colour`) and the shape group (`r searchRT.fup$full_result$TD_Tonly_Shape`). However, this effect appears to be larger for the colour group and when it is tested directly using an independent samples t-test, the results show that distractor cost is indeed significantly larger for the colour group than the shape group (`r intEffectTTest$full_result`). 
```

(ref:behavDistInt) Plot showing the response time cost caused by the presence of a coloured distractor during the search task for each group (response time in distractor present trials is subtracted from distractor abesent trials). Participants assigned to respond to colour in the categorisation task (shown in green) have significantly higher costs during the search task than participants assigned to repsond to shape in the categorisation task (shown in grey). Individual response time costs are depicted as dots alongside a boxplot and violin plot to visualise the range and distribution of costs for each group.

```{r DistIntViolin, fig.cap = "(ref:behavDistInt)"}
behavData %>%
  filter(Procedure.Trial. == "TaskC",switchRate>minSwitchRate, CompSearch.ACC==1, CompSearch.RT < compCutoff) %>%
  group_by(Subject, TrialType, Group) %>%
  summarise(RT = mean(CompSearch.RT)) %>%
  spread(TrialType, RT) %>%
  mutate(DistInt = TD-Tonly, GroupNum = as.integer(Group)) %>%
  ggplot( aes(x = GroupNum, y = DistInt, fill = Group)) +
  geom_flat_violin(aes(fill = Group),position = position_nudge(x = .1, y = 0), adjust = 1.5, trim = FALSE, alpha = .75, colour = NA) +
  geom_point(aes(x = GroupNum-0.15, y = DistInt, colour = Group),position = position_jitter(width = .05), size = 4, shape = 20) +
  geom_boxplot(aes(x = GroupNum, y = DistInt, fill = Group),outlier.shape = NA, alpha = .75, width = .1, colour = "black") +
  scale_colour_manual(values=c("green4", "gray42")) +
  scale_fill_manual(values=c("green4", "gray42")) +
  labs(y = "Distractor Cost (ms)") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        text= element_text(size=18)
        )
```


```{r, echo = FALSE, include = FALSE}
rm( groupInfo,intEffectTTest, acc, acc.res, acc.stat, autoCor, Cor, distCost, rt, rt.res, rt.stat, sData, searchAcc, searchAcc.aov, searchAcc.res, searchRT, searchRT.aov, searchRT.fup, searchRT.res, t.out, sub, subj, survabrej, survallrej, survTrials, alltrials)
gc()
```

### ERP results

```{r organiseData, echo = FALSE, include = FALSE}
dPath = 'CSL_Visuals/'
fPrefix = 'N2pc'

#Load group data
groupdata = read.csv(file="CSL_Visuals/SophiaGroupAssignment_provisional.csv")
groupdata = groupdata %>% mutate(Group = ifelse(Group == 1, "Colour", "Shape"))
groupdata$Reject = as.factor(groupdata$Reject)

#####
#Creates aggregate of all participant data (needs dPath and fPrefix)
eFilePattern = paste(fPrefix,"*_epochs.csv", sep="")
lFilePattern = paste(fPrefix,"*_LH.csv", sep="")
rFilePattern = paste(fPrefix,"*_RH.csv", sep="")
eFileList = list.files(dPath, pattern=glob2rx(eFilePattern))
lFileList = list.files(dPath, pattern=glob2rx(lFilePattern))
rFileList = list.files(dPath, pattern=glob2rx(rFilePattern))

#create variables using first dataset
epochInfo = read.csv(file = paste(dPath,eFileList[1], sep=""))
epochInfo$Subject = 1
epochInfo$Group = groupdata$Group[1]
epochInfo$Reject = groupdata$Reject[1]
epochInfo$switchRate = switchRates$SR[1]
lHemData = read.csv(file = paste(dPath,lFileList[1], sep=""), header = FALSE)
rHemData = read.csv(file = paste(dPath,rFileList[1], sep=""), header = FALSE)
#append the other datasets to the above variables
for (subj in 2:length(eFileList)) {
  curEpochInfo = read.csv(file = paste(dPath,eFileList[subj], sep=""))
  curEpochInfo$Subject = subj
  curEpochInfo$Group = groupdata$Group[subj]
  curEpochInfo$Reject = groupdata$Reject[subj]
  curEpochInfo$switchRate = switchRates$SR[subj]
  curLHemData = read.csv(file = paste(dPath,lFileList[subj], sep=""), header = FALSE)
  curRHemData = read.csv(file = paste(dPath,rFileList[subj], sep=""), header = FALSE)
  
  epochInfo = rbind(epochInfo, curEpochInfo)
  lHemData = rbind(lHemData, curLHemData)
  rHemData = rbind(rHemData, curRHemData)
}
#Tidy the variables, remove unnecessary and convert to factors
epochInfo$Subject = as.factor(epochInfo$Subject)
epochInfo$Group = as.factor(epochInfo$Group)
epochInfo$VarName8 = NULL
epochInfo$VarName9 = NULL
epochInfo$VarName10 = NULL
epochInfo$VarName11 = NULL

#clear stuff that I don't need
rm(curEpochInfo,curLHemData,curRHemData, fPrefix, eFileList, eFilePattern, lFileList, lFilePattern, rFileList, rFilePattern, subj, groupdata)
#####
#Permutation can be done at this stage using epochInfo$Hemifield = sample(epochInfo$Hemifield, replace=FALSE)
#combine all the data together into one long table
gathercols = colnames(lHemData)
lHemData$Hem = "Left"
rHemData$Hem = "Right"
scalpData = rbind(lHemData,rHemData)
origEpochInfo = rbind(epochInfo,epochInfo)

allData <- cbind(origEpochInfo, scalpData)
allData <- gather(allData, "sample", "voltage", gathercols, factor_key = TRUE)

#Tidy variable names etc. and create any necessary variables - could use unite
allData$sample <- as.integer(substring(allData$sample,2))
allData <- allData %>% mutate(Contra = ifelse(Hemifield==Hem, "Ipsilateral", "Contralateral"))
allData <- allData %>% mutate(Stimulus = as.factor(paste(LatStim," (",MidStim," mid)", sep = "")))
allData <- allData %>% mutate(Object = as.factor(paste(Group,LatStim, sep="")))
allData$Object <- recode(allData$Object, ShapePredictor = "Shape", ColourPredictor="Colour", ShapeNonPred = "Colour", ColourNonPred = "Shape")
allData$Stimulus <- recode(allData$Stimulus, "Target (None mid)" = "Target only", "Target (Distractor mid)"="Target", "Distractor (Target mid)" = "Distractor")

#clear stuff that I don't need
rm(origEpochInfo,scalpData)
#Change factor labels
allData$Object = factor(allData$Object, labels = c("ColourDistractor", "ColourNone", "Lat. Shape", "Lat. Colour", "ColourTarget", "ShapeDistractor", "ShapeNone", "ShapeTarget"))
allData$Object = factor(allData$Object, levels = c("Lat. Colour", "Lat. Shape", "ColourNone", "ShapeNone", "ColourTarget", "ShapeTarget", "ColourDistractor", "ShapeDistractor"))
allData$Group = factor(allData$Group, levels = c("Colour", "Shape"))
allData$TrialType = factor(allData$TrialType, levels = c("Switch", "Rep"))
allData$Stimulus = factor(allData$Stimulus, levels = c("Target only", "Target", "Distractor"))
rm(lHemData,rHemData, epochInfo, gathercols)
gc()
```

```{r setParams}
baseline = 200
srateMultiplier = 1
plotWidth = 24
plotHeight = 9
fontSize = 12
winSize = 50


learnRej <- allData %>%
  filter(Event == "Learn", sample == 1, Contra == "Contralateral") %>%
  group_by(Subject) %>%
  summarise(Trials = sum(sample)) %>%
  mutate(learnReject = ifelse(Trials < 400,1,0))
searchRej <- allData %>%
  filter(Event == "Search", sample == 1, Contra == "Contralateral") %>%
  group_by(Subject) %>%
  summarise(Trials = sum(sample)) %>%
  mutate(searchReject = ifelse(Trials < 500,1,0))
#mutate(allData, learnRej = NaN, searchRej = NaN)
for (i in unique(allData$Subject)) {
  allData$learnRej[allData$Subject == i] = learnRej$learnReject[learnRej$Subject==i]
  allData$searchRej[allData$Subject == i] = searchRej$searchReject[searchRej$Subject==i]
}
```

#### Categorization task

```{r, findCatCompWindows}
grandTarget <- allData %>%
  filter( Event == "Learn" & LatStim == "Predictor" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
NtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
NtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
grandDist <- allData %>%
  filter( Event == "Learn" & LatStim == "NonPred" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
PdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
PdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
```

```{r learnGrand, include = FALSE}
allData %>%
  filter(Event == "Learn", learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  group_by(LatStim,sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_rect(aes(xmin = NtStart, xmax = NtEnd, ymin = -Inf, ymax = 0), fill = "lemonchiffon") +
    geom_rect(aes(xmin = PdStart, xmax = PdEnd, ymin = 0, ymax = Inf), fill = "lemonchiffon") +
    geom_line(aes(colour = LatStim),size=1) +
    scale_colour_manual(values=c("green4", "gray42"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(3, "lines"), text= element_text(size=fontSize),
          axis.text.x = element_text(size = fontSize*0.93),
          axis.text.y = element_text(size = fontSize*0.93),
          legend.title = element_text( size = fontSize*1.1),
          legend.text = element_text( size = fontSize*0.93),
          legend.position = "bottom"
          )
```

```{r learnStats, echo=FALSE, include = FALSE}
learnNtShape <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Event == "Learn" & learnRej == 0 & sample>NtStart & sample < NtEnd & Object == "Lat. Shape", switchRate>minSwitchRate) %>%
  group_by(Object,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage))
learn.NtShape.aov <- aov_ez(
  data = learnNtShape,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
learn.NtShape.results <- apa_print(learn.NtShape.aov)
#Followup
learn.NtShape.fup <- apa_print.emmGrid(pairs(emmeans(learn.NtShape.aov, ~Contra|Group)))
group.shpnt <- learnNtShape %>%
  group_by(Group) %>%
  summarise(mean = mean(mV), se = sqrt(sd(mV)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"\\mu V, se = ", as.character(round(se,2)), sep = ""))
elecLat.shpnt <- learnNtShape %>%
  group_by(Contra) %>%
  summarise(mean = mean(mV), se = sqrt(sd(mV)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"\\mu V, se = ", as.character(round(se,2)), sep = ""))
intr.shpnt <- learnNtShape %>%
  group_by(Contra,Group) %>%
  summarise(mean = mean(mV), se = sqrt(sd(mV)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"\\mu V, se = ", as.character(round(se,2)), sep = ""))
diffDirect <- learnNtShape %>%
  spread(Contra,mV) %>%
  mutate(difference = Contralateral-Ipsilateral)
t.test(diffDirect$difference[diffDirect$Group == "Shape"], diffDirect$difference[diffDirect$Group == "Colour"],paired = FALSE)

learnNtCol <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Event == "Learn" & learnRej == 0 & sample>NtStart & sample < NtEnd & Object == "Lat. Colour", switchRate>minSwitchRate) %>%
  group_by(Object,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage))
learn.NtCol.aov <- aov_ez(
  data = learnNtCol,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
learn.NtCol.results <- apa_print(learn.NtCol.aov)
#Followup
learn.NtCol.fup <- apa_print.emmGrid(pairs(emmeans(learn.NtCol.aov, ~Contra|Group)))
group.colnt <- learnNtCol %>%
  group_by(Group) %>%
  summarise(mean = mean(mV), se = sqrt(sd(mV)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"\\mu V, se = ", as.character(round(se,2)), sep = ""))
elecLat.colnt <- learnNtCol %>%
  group_by(Contra) %>%
  summarise(mean = mean(mV), se = sqrt(sd(mV)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"\\mu V, se = ", as.character(round(se,2)), sep = ""))
intr.colnt <- learnNtCol %>%
  group_by(Contra,Group) %>%
  summarise(mean = mean(mV), se = sqrt(sd(mV)/length(unique(Subject)))) %>%
  mutate(text = paste("M = ", as.character(round(mean,2)),"\\mu V, se = ", as.character(round(se,2)), sep = ""))
diffDirect <- learnNtCol %>%
  spread(Contra,mV) %>%
  mutate(difference = Contralateral-Ipsilateral)
t.test(diffDirect$difference[diffDirect$Group == "Shape"], diffDirect$difference[diffDirect$Group == "Colour"],paired = FALSE)

learnPdShape <- allData %>%
  mutate(sample = sample*4-baseline) %>%
  filter(Event == "Learn" & learnRej == 0 & sample>PdStart & sample < PdEnd & Object == "Lat. Shape", switchRate>minSwitchRate) %>%
  group_by(Object,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage))
learn.PdShape.aov <- aov_ez(
  data = learnPdShape,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
learn.PdShape.results <- apa_print(learn.PdShape.aov)

learnPdCol <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Event == "Learn" & learnRej == 0 & sample>PdStart & sample < PdEnd & Object == "Lat. Colour", switchRate>minSwitchRate) %>%
  group_by(Object,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage))
learn.PdCol.aov <- aov_ez(
  data = learnPdCol,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
learn.PdCol.results <- apa_print(learn.PdCol.aov)
```

In the categorisation task, our ERP analyses focused on the lateralised response to each object (either the shape singleton or the colour singleton). For each ERP there were two time windows of interest, the Nt time window (`r sprintf("%i to %ims", NtStart, NtEnd)`) and the Pd time window (`r sprintf("%i to %ims", PdStart, PdEnd)`). See figure\ \@ref(fig:makeLearnPlots). We performed a set of mixed 2x2 ANOVAS where electrode laterality (contralateral vs. ipsilateral) was the within-subject factor and group (colour vs. shape) was the between-subject factor. This was performed for both components (NT and PD) elicited by each of the lateralised stimuli (colour and shape singletons).

##### Lateral colour singleton, midline shape

In displays where the colour singleton is lateralised and the shape singleton is on the midline, voltages in the NT time window do not differ between participants in the colour group (`r group.colint$text[1]`) and participants in the shape group (`r group.colint$text[2]`, `r learn.NtCol.results$full$Group` ), nor is there any difference between the contralateral electrode site (`r elecLat.colint$text[1]`) and ipsilateral electrode site (`r elecLat.colint$text[2]`, `r gsub("= .000\\$", "< .001\\$",gsub("= 0.00\\$","< 0.01\\$",learn.NtCol.results$full$Contra))`). We do, however, observe a signicifcant interaction between group and electrode laterality (`r learn.NtCol.results$full$Group_Contra`). For participants performing colour categorisation, a lateralised colour singleton elicits a more negative voltage at contralateral electrode sites (`r intr.colint$text[1]`) than ipsilateral electrode sites (`r intr.colint$text[3]`, `r learn.NtCol.fup$full_result$Contralateral_Ipsilateral_Colour`), whereas for participants performing shape lateralisation, a lateralised colour singleton elicits a more positive voltage at contralateral electrode sites (`r intr.colint$text[2]`) than ipsilateral electrode sites (`r intr.colint$text[4]`, `r learn.NtCol.fup$full_result$Contralateral_Ipsilateral_Shape`).

When evaluating the PD time range, we observe no main effects of group (`r learn.PdCol.results$full$Group`) or electrode laterality (`r learn.PdCol.results$full$Contra`), and no interaction between group and electrode laterality (`r learn.PdCol.results$full$Group_Contra`).

##### Lateral shape singleton, midline colour

In displays where the shape singleton is lateralised and the colour singleton is on the midline, voltages in the NT time window do not differ between participants in the colour group (`r group.shpint$text[1]`) and participants in the shape group (`r group.shpint$text[2]`, `r learn.NtShape.results$full$Group` ), nor is there any difference between the contralateral electrode site (`r elecLat.shpint$text[1]`) and ipsilateral electrode site (`r elecLat.shpint$text[2]`, `r gsub("= .000\\$", "< .001\\$",gsub("= 0.00\\$","< 0.01\\$",learn.NtShape.results$full$Contra))`). We do, however, observe a signicifcant interaction between group and electrode laterality (`r learn.NtShape.results$full$Group_Contra`). For participants performing shape categorisation, a lateralised shape singleton elicits a more negative voltage at contralateral electrode sites (`r intr.shpint$text[1]`) than ipsilateral electrode sites (`r intr.shpint$text[3]`, `r learn.NtShape.fup$full_result$Contralateral_Ipsilateral_Colour`), whereas for participants performing colour lateralisation, a lateralisedshape singleton elicits a more positive voltage at contralateral electrode sites (`r intr.shpint$text[2]`) than ipsilateral electrode sites (`r intr.shpint$text[4]`, `r learn.NtShape.fup$full_result$Contralateral_Ipsilateral_Shape`).

When evaluating the PD time range, we observe no main effects of group (`r learn.PdShape.results$full$Group`) or electrode laterality (`r learn.PdShape.results$full$Contra`), and no interaction between group and electrode laterality (`r learn.PdShape.results$full$Group_Contra`).

(ref:learnERPCap) Subtracted ERPs showing the lateralised response to displays in the categorisation task. The top panel depicts the different neural responses elicited by a lateralised colour singleton for participants who are tasked with responding to the colour singleton (shown in green) versus those tasked with responding to the shape singleton (shown in grey). The bottom panel depicts the different neural responses elicited by a lateralised colour singleton, again separated by those in the colour group (green) and those in the shape group (grey).

```{r makeLearnPlots, fig.cap="(ref:learnERPCap)"}
imgCol <- readPNG("learnCol.png")
imgShape <- readPNG("learnShape.png")
#Subtracted
allData %>%
  filter(Event == "Learn", learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  group_by(Object,sample,Contra,Group) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_rect(aes(xmin = NtStart, xmax = NtEnd, ymin = -Inf, ymax = 0), fill = "lemonchiffon") +
    geom_rect(aes(xmin = PdStart, xmax = PdEnd, ymin = 0, ymax = Inf), fill = "lemonchiffon") +
    geom_line(aes(colour = Group),size=1) +
    scale_colour_manual(values=c("green4", "gray42"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    coord_cartesian(clip = 'off') +
    geom_vline(xintercept = 0,linetype = "dashed" )+
    geom_hline(yintercept = 0,linetype = "dashed") +
    annotation_custom2(rasterGrob(imgCol, interpolate=TRUE), 
                       xmin=-45, 
                       xmax=45, 
                       ymin=0.25, 
                       ymax=3, 
                       data=. %>% filter(Object  == "Lat. Colour"))+
    annotation_custom2(rasterGrob(imgShape, interpolate=TRUE), 
                       xmin=-45, 
                       xmax=45, 
                       ymin=0.25, 
                       ymax=3, 
                       data=. %>% filter(Object  == "Lat. Shape"))+
    facet_grid(Object~.) +
    theme_apa() +
    theme(panel.spacing.y = unit(3, "lines"), text= element_text(size=fontSize),
          axis.text.x = element_text(size = fontSize*0.93),
          axis.text.y = element_text(size = fontSize*0.93),
          legend.title = element_text( size = fontSize*1.1),
          legend.text = element_text( size = fontSize*0.93),
          legend.position = "bottom",
          plot.margin = unit(c(2,2,0,2),"cm")
          )
ggsave("LearnSubtracted.pdf", dpi = 300, width = 30, height = 20, units = c("cm"))
```

#### Search task

```{r findSearchCompWindows}
grandTarget <- allData %>%
  filter( Event == "Search" & LatStim == "Target" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
NtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
NtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
grandDist <- allData %>%
  filter( Event == "Search" & LatStim == "Distractor" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
PdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
PdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
```

```{r searchGrand, include = FALSE}
allData %>%
  filter( Event == "Search" & LatStim != "None" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  group_by(LatStim,sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_rect(aes(xmin = NtStart, xmax = NtEnd, ymin = -Inf, ymax = 0), fill = "lemonchiffon") +
    geom_rect(aes(xmin = PdStart, xmax = PdEnd, ymin = 0, ymax = Inf), fill = "lemonchiffon") +
    geom_line(aes(colour = LatStim),size=1) +
    #scale_colour_manual(values=c("green4", "gray42"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(3, "lines"), text= element_text(size=fontSize),
          axis.text.x = element_text(size = fontSize*0.93),
          axis.text.y = element_text(size = fontSize*0.93),
          legend.title = element_text( size = fontSize*1.1),
          legend.text = element_text( size = fontSize*0.93),
          legend.position = "bottom"
          )
```

```{r searchStatsBasic, echo=FALSE}
searchNtTO <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Event == "Search" & LatStim != "None" & searchRej == 0 & sample>NtStart & sample < NtEnd & Stimulus == "Target only", switchRate>minSwitchRate) %>%
  group_by(Stimulus,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage)) 
search.NtTO.aov <- aov_ez(
  data = searchNtTO,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
search.NtTO.results <- apa_print(search.NtTO.aov)
search.NtTO.fup <- apa_print.emmGrid(pairs(emmeans(search.NtTO.aov, ~Contra|Group)))

searchNtTD <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Event == "Search" & LatStim != "None" & searchRej == 0 & sample>NtStart & sample < NtEnd & Stimulus == "Target", switchRate>minSwitchRate) %>%
  group_by(Stimulus,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage))
search.NtTD.aov <- aov_ez(
  data = searchNtTD,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
search.NtTD.results <- apa_print(search.NtTD.aov)
search.NtTD.fup <- apa_print.emmGrid(pairs(emmeans(search.NtTD.aov, ~Contra|Group)))
diffDirect <- searchNtTD %>%
  spread(Contra,mV) %>%
  mutate(difference = Contralateral-Ipsilateral)
NtTDdiff <- apa_print(t.test(diffDirect$Contralateral[diffDirect$Group == "Shape"], diffDirect$Ipsilateral[diffDirect$Group == "Shape"],paired = TRUE))
intr.tdnt.se <- searchNtTD %>%
  spread(Contra, mV) %>%
  mutate(seDiff = Contralateral-Ipsilateral) %>%
  group_by(Group) %>%
  summarise(mean = mean(seDiff),se = sqrt(sd(seDiff)/length(unique(Subject)))) %>%
  mutate( text = paste("$\\Delta M = ", as.character(round(mean,2)), ", se = ", as.character(round(se,2)), "$", sep=""))

searchNtDT <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Event == "Search" & LatStim != "None" & searchRej == 0 & sample>NtStart & sample < NtEnd & Stimulus == "Distractor", switchRate>minSwitchRate) %>%
  group_by(Stimulus,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage))
search.NtDT.aov <- aov_ez(
  data = searchNtDT,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
search.NtDT.results <- apa_print(search.NtDT.aov)
search.NtDT.fup <- apa_print.emmGrid(pairs(emmeans(search.NtDT.aov, ~Contra|Group)))

searchPdDT <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter( Event == "Search" & LatStim != "None" & searchRej == 0 & sample>PdStart & sample < PdEnd & Stimulus == "Distractor", switchRate>minSwitchRate) %>%
  group_by(Stimulus,Subject,Contra,Group) %>%
  summarise(mV = mean(voltage))
search.PdDT.aov <- aov_ez(
  data = searchPdDT,
  dv = "mV",
  id = "Subject", 
  within = c("Contra"),
  between = "Group"
)
search.PdDT.results <- apa_print(search.PdDT.aov)
search.PdDT.fup <- apa_print.emmGrid(pairs(emmeans(search.PdDT.aov, ~Contra|Group)))
diffDirect <- searchPdDT %>%
  spread(Contra,mV) %>%
  mutate(difference = Contralateral-Ipsilateral)
PdDTdiff <- apa_print(t.test(diffDirect$difference[diffDirect$Group == "Colour"], diffDirect$difference[diffDirect$Group == "Shape"],paired = FALSE))
intr.dtpd.se <- searchPdDT %>%
  spread(Contra, mV) %>%
  mutate(seDiff = Contralateral-Ipsilateral) %>%
  group_by(Group) %>%
  summarise(mean = mean(seDiff),se = sqrt(sd(seDiff)/length(unique(Subject)))) %>%
  mutate( text = paste("$\\Delta M = ", as.character(round(mean,2)), ", se = ", as.character(round(se,2)), "$", sep=""))

```

Next we focused on the lateralised response to targets and distractors in the search displays as a function of group assignment. Evidence for the effect of selection history would again come from the interaction between group and lateralised ERP activity. We performed a set of mixed 2x2 ANOVAS where electrode laterality (contralateral vs. ipsilateral) was the within-subject factor and group (colour vs. shape) was the between-subject factor. This was performed for NT time window elicited by each of the display types (target lateralised - distractor absent, target lateralised - distractor on the midline, and distractor lateralised - target on the midline), as well as the PD time window in the case of a lateralised distractor.
`r #the Nt time window (r sprintf("%i to %ims", NtStart, NtEnd)) and the Pd time window (r sprintf("%i to %ims", PdStart, PdEnd))`

##### Target response - Distractor absent trials

In the target only displays the contralateral response was more negative than the ipsilateral response, indicating a significant main effect of hemisphere (`r search.NtTO.results$full$Contra`). Neither the main effect of group (`r search.NtTO.results$full$Group`), nor the interaction between group and hemisphere reached significance (`r search.NtTO.results$full$Group_Contra`). 

##### Target response - Distractor present trials

When the target was lateralised in the presence of a midline distractor, we observed no significant main effect of group (`r search.NtTD.results$full$Group`), however there was a significant main effect of electrode laterality (`r search.NtTD.results$full$Contra`). This main effect is superceeded by an interaction between group and electrode laterality which shows that this voltage difference between contralateral and ipsilateral electrode sites is is significantly larger for participants in the shape group (`r intr.tdnt.se$text[2]`) than those in the colour group(`r paste(intr.tdnt.se$text[1], ", ", search.NtTD.results$full$Group_Contra, sep = "")`). 

`r #Follow-up comparisons reveal that while a significant NT was elicited for participants in both the colour (r search.NtTD.fup$full_result$Contralateral_Ipsilateral_Colour) and shape group (r search.NtTD.fup$full_result$Contralateral_Ipsilateral_Shape). When NT amplitude is compared directly with an independent samples t test, the results show that the NT is significantly larger for the shape group than the colour group (r NtTDdiff$full_result).`

##### Distractor response - Distractor present trials

For the lateralised distractor response, results of the NT time range showed neither an effect of group(`r search.NtDT.results$full$Group`), nor of electrode laterality (`r search.NtDT.results$full$Contra`), nor an interaction between group and electrode laterality (`r search.NtDT.results$full$Group_Contra`).

Results for the lateralised distractor showed no significant main effect of group (`r search.PdDT.results$full$Group`), however there was a significant main effect of electrode laterality (`r search.PdDT.results$full$Contra`). A significant interaction between group and electrode laterality (`r search.PdDT.results$full$Group_Contra`) revealed that a significant Pd was elicited for participants in the colour group (`r search.PdDT.fup$full_result$Contralateral_Ipsilateral_Colour`), however the difference between the contralateral and ipsilateral electrodes did not reach significance for the shape group (`r search.PdDT.fup$full_result$Contralateral_Ipsilateral_Shape`). 

`r #When Pd amplitude is compared directly with an independent samples t test, the results show that the Pd was significantly larger for the colour group than the shape group (r PdDTdiff$full_result).`

(ref:searchERPCap) Subtractracted ERPs showing the lateralised response to a target in the absence of distractors (top, the target in the presence of a distractor (middle), and the distractor (bottom) for each group in the search task. Example displays are shown for each ERP.

```{r makeSearchPlots, fig.cap="(ref:searchERPCap)", fig.height = 5.25,  fig.align = "center"}

imgTO = readPNG("searchTO.png")
imgTD = readPNG("searchTD.png")
imgDT = readPNG("searchDT.png")
allData %>%
  filter( Event == "Search" & LatStim != "None" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  group_by(Stimulus,sample,Contra,Group) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_rect(aes(xmin = NtStart, xmax = NtEnd, ymin = -Inf, ymax = 0), fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor"),aes(xmin = PdStart, xmax = PdEnd, ymin = 0, ymax = Inf), fill = "lemonchiffon") +
    geom_line(aes(colour = Group),size=1) +
    scale_colour_manual(values=c("green4", "gray42"))+
    #scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    coord_cartesian(clip = 'off') +
    geom_vline(xintercept = 0,linetype = "dashed" )+
    geom_hline(yintercept = 0,linetype = "dashed") +
    annotation_custom2(rasterGrob(imgTO, interpolate=TRUE), 
                       xmin=-45, 
                       xmax=45, 
                       ymin=0.5, 
                       ymax=3.2, 
                       data=. %>% filter(Stimulus  == "Target only"))+
    annotation_custom2(rasterGrob(imgTD, interpolate=TRUE), 
                       xmin=-45, 
                       xmax=45, 
                       ymin=0.5, 
                       ymax=3.2, 
                       data=. %>% filter(Stimulus  == "Target"))+
    annotation_custom2(rasterGrob(imgDT, interpolate=TRUE), 
                       xmin=-45, 
                       xmax=45, 
                       ymin=0.5, 
                       ymax=3.2, 
                       data=. %>% filter(Stimulus  == "Distractor"))+
    facet_grid(Stimulus~.) +
    theme_apa() +
    theme(panel.spacing.y = unit(3, "lines"), text= element_text(size=fontSize),
          axis.text.x = element_text(size = fontSize*0.93),
          axis.text.y = element_text(size = fontSize*0.93),
          legend.title = element_text( size = fontSize*1.1),
          legend.text = element_text( size = fontSize*0.93),
          legend.position = "bottom",
          plot.margin = unit(c(2,2,0,2),"cm")
          )
ggsave("SearchSubtracted.pdf", dpi = 300, width = 30, height = 40, units = c("cm"))
```

```{r clearData, include = FALSE}
rm(list = ls(pattern = "search"))
rm(list = ls(pattern = "learn"))
rm(list = ls(pattern = "img"))
rm(list = ls(pattern = "grand"))
rm(allData, diffDirect, NtTDdiff, PdDTdiff)
gc()
```
## Voluntary Task Selection

### Task Choice

```{r taskChoiceStats}
bias.dat <- behavData %>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
  group_by(Block, Subject, Group) %>%
  mutate(choseSearch = ifelse(is.na(Compound),0,1)) %>%
  summarise(percentSearch = mean(choseSearch)*100) %>%
  mutate(bias = abs(50-percentSearch)) %>%
  group_by(Subject, Group) %>%
  summarise(bias = mean(bias))
bias.stat <- t.test(bias.dat$bias, mu = 0)
```

Participants were informed to attempt to keep the task selection balanced at around 50% search and 50% choice trials throughout the experiment. In order to measure this we calculated task choice across the task and show that participants typically succeeded in maintaining approximately 50% of each trial across the task (see figure\ \@ref(fig:choseSearch)).

(ref:choseSearchPlot) Proportion of search trials chosen by each individual across blocks throughout the experiment. Colour differentiates subjects in the shape and colour group. (lines have been smoothed with a loess function for visualisation)

```{r choseSearch, fig.cap = "(ref:choseSearchPlot)"}
behavData %>%
  filter(switchRate > minSwitchRate) %>%
  group_by(Block, Subject, Group) %>%
  mutate(choseSearch = ifelse(is.na(Compound),0,1)) %>%
  summarise(percentSearch = mean(choseSearch)*100) %>%
  ggplot(aes(x=Block, y=percentSearch, colour = Group, group = Subject)) +
  geom_smooth(se = FALSE, alpha = 0.75) +
  scale_colour_manual(values=c("green4", "gray42")) +
  labs(y = "Percentage of search trials chosen") +
  lims(y=c(0,100))
```

```{r choiceRT}
choiceRT.dat <- behavData %>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff, Choice1.RT>0) %>%
  group_by(Subject,Group, repswitch) %>%
  summarise(mean = mean(Choice1.RT))
choiceRT.stat <- aov_ez(
  data = choiceRT.dat,
  dv = "mean",
  id = "Subject", 
  within = c("repswitch"),
  between = "Group"
)
choiceRT.res <- apa_print(choiceRT.stat)
choiceRT.fup <- apa_print.emmGrid(pairs(emmeans(choiceRT.stat, ~repswitch|Group)))

```

A 2x2 ANOVA was also performed in order to evaluate the effect of task transition (repeat vs switch) and group (colour vs shape) on the time taken to make a task choice. Results (depicted in figure\ \@ref(fig:choiceRTPlot)) show no significant main effects of Group (`r choiceRT.res$full_result$Group`) and task transition (`r choiceRT.res$full_result$repswitch`), as well as no significant interaction between group and task transition (`r choiceRT.res$full_result$Group_repswitch`). 

(ref:chRTPlot) Time taken for participants in the colour group (green) and the shape group (grey) to make their task selection at the start of each trial. This is depicted separately for trials where they chose to switch task versus those where they chose to repeat the previous task. Thick lines represent the group averages while thin lines represent individual data.

```{r choiceRTPlot, fig.cap="(ref:chRTPlot)"}
choiceRTAvg <- behavData %>%
  filter(switchRate > minSwitchRate, Choice1.RT>0) %>%
  group_by(Group, repswitch) %>%
  summarise(mean = mean(Choice1.RT))
behavData %>%
  filter(switchRate > minSwitchRate, Choice1.RT>0) %>%
  group_by(Subject,Group, repswitch) %>%
  summarise(mean = mean(Choice1.RT)) %>%
  ggplot(aes(x = repswitch, y = mean)) +
  geom_point(aes(colour = Group), size = 2, alpha = 0.3) +
  geom_line(aes(colour = Group, group = Subject), alpha = 0.3) +
  geom_point(data = choiceRTAvg, aes(colour = Group),size = 5) +
  geom_line(data = choiceRTAvg, aes(group = Group, colour = Group), size=2) +
  facet_grid(.~Group) +
  scale_colour_manual(values=c("green4", "gray42")) +
  scale_y_continuous(name = "Time taken for task choice (ms)",limits = c(0,500)) +
  scale_x_discrete(limits=c("switch", "rep"), labels = c("Switch", "Repetition")) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        #axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        #strip.text.x = element_blank(),
        strip.background = element_rect(fill = "white"),
        legend.position = "none",
        text= element_text(size=18)
        )
```

### Switch Rates

```{r switchRateStats}
switch <- behavData %>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
  summarise(mean = mean(SwitchCount))
SR <- behavData %>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
  group_by(Subject,Group) %>%
  summarise(mean = mean(SwitchCount))
shapeSR.t <- t.test(SR$mean[SR$Group=="Shape"], mu = 0.5)
shapeSR.res <- apa_print(shapeSR.t)
colourSR.t <- t.test(SR$mean[SR$Group=="Colour"], mu = 0.5)
colourSR.res <- apa_print(colourSR.t)
comparisonSR = t.test(SR$mean[SR$Group=="Colour"],SR$mean[SR$Group=="Shape"], alternative = "less")
comparisonSR.res = apa_print(comparisonSR)
```

Participants in the task were encouraged to try to make their task selections as random as possible which would produce a switch rate of 50%, however average switch rate across all participants was `r as.character(round(switch$mean*100, digits = 2))`%. Analysis of the voluntary task choice shows that while participants in the shape group showed no significant deviation from a switch rate of 50% (`r shapeSR.res$full_result`), participants in the colour group showed a significant repetiton bias (`r colourSR.res$full_result`). When we directly tested whether switch rates in the colour group were lower than the shape group we also see a significant difference (`r comparisonSR.res$full_result`). Switch rates are shown in figure\ \@ref(fig:SwitchRateViolin).

(ref:SRPlot) Voluntary switch rates for each individual separated by group assignment. Dots show each individual's switch rate alongside a boxplot and violin plot to display the range and distribution of switch rates. A switch rate of 50% is the expected switch rate when participants are randomly selecting the task on each trial as instructed. This point has been marked with a horizontal line for reference.

```{r SwitchRateViolin, fig.cap = "(ref:SRPlot)"}
behavData %>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
  mutate(GroupNum = as.integer(Group)) %>%
  group_by(Subject,Group, GroupNum) %>%
  summarise(mean = mean(SwitchCount)*100) %>%
  ggplot( aes(x = GroupNum, y = mean, fill = Group)) +
  geom_hline(aes(yintercept=50), size = 1.5, linetype="dashed") +
  geom_flat_violin(aes(fill = Group),position = position_nudge(x = .1, y = 0), adjust = 1.5, trim = FALSE, alpha = .75, colour = NA) +
  geom_point(aes(x = GroupNum-0.15, y = mean, colour = Group),position = position_jitter(width = .05), size = 4, shape = 20) +
  geom_boxplot(aes(x = GroupNum, y = mean, fill = Group),outlier.shape = NA, alpha = .75, width = .1, colour = "black") +
  scale_colour_manual(values=c("green4", "gray42")) +
  scale_fill_manual(values=c("green4", "gray42")) +
  labs(y = "Switch Rate (%)") +
  lims(y=c(0,100)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        text= element_text(size=18)
        )
```

### Switch Costs

```{r switchCostStats}
searchSC.dat <- behavData %>%
filter(Procedure.Trial. == "TaskC") %>%
filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
group_by(Subject, Group, SwitchCount) %>%
summarise(RT = mean(respTime))
searchSC.stat <- aov_ez(
  data = searchSC.dat,
  dv = "RT",
  id = "Subject", 
  within = c("SwitchCount"),
  between = "Group"
)
searchSC.res <- apa_print(searchSC.stat)

learnSC.dat <- behavData %>%
filter(Procedure.Trial. == "TaskL") %>%
filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
group_by(Subject, Group, SwitchCount) %>%
summarise(RT = mean(respTime))
learnSC.stat <- aov_ez(
  data = learnSC.dat,
  dv = "RT",
  id = "Subject", 
  within = c("SwitchCount"),
  between = "Group"
)
learnSC.res <- apa_print(learnSC.stat)
learnSC.fup <- apa_print.emmGrid(pairs(emmeans(learnSC.stat, ~SwitchCount|Group)))
intr.lrnSC <- learnSC.dat %>%
  spread(Contra, RT) %>%
  mutate(seDiff = Contralateral-Ipsilateral) %>%
  group_by(Group) %>%
  summarise(mean = mean(seDiff),se = sqrt(sd(seDiff)/length(unique(Subject)))) %>%
  mutate( text = paste("$\\Delta M = ", as.character(round(mean,2)), ", se = ", as.character(round(se,2)), "$", sep=""))

#Switch costs correlate with distractor interference?
#Switch costs correlate with PD amplitude?
learnSC.dat1 <- learnSC.dat %>%
  spread(SwitchCount, RT) %>%
  mutate(sc = Switch-Rep)

SC.dat <- behavData %>%
filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
group_by(Subject, Group, SwitchCount, Procedure.Trial.) %>%
summarise(RT = mean(respTime))
SC.stat <- aov_ez(
  data = SC.dat,
  dv = "RT",
  id = "Subject", 
  within = c("SwitchCount", "Procedure.Trial."),
  between = "Group"
)
pairs(emmeans(SC.stat, ~SwitchCount|Group*Procedure.Trial.))
pairs(emmeans(SC.stat, ~SwitchCount|Group))
pairs(emmeans(SC.stat, ~SwitchCount|Procedure.Trial.))
colourSC.dat <- behavData %>%
  filter(Group == "Colour")%>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
  mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
  group_by(Subject, Group, SwitchCount, Procedure.Trial.) %>%
  summarise(RT = mean(respTime))
colourSC.stat <- aov_ez(
  data = colourSC.dat,
  dv = "RT",
  id = "Subject", 
  within = c("SwitchCount", "Procedure.Trial.")
)
shapeSC.dat <- behavData %>%
  filter(Group == "Shape")%>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
  mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
  group_by(Subject, Group, SwitchCount, Procedure.Trial.) %>%
  summarise(RT = mean(respTime))
shapeSC.stat <- aov_ez(
  data = shapeSC.dat,
  dv = "RT",
  id = "Subject", 
  within = c("SwitchCount", "Procedure.Trial.")
)



SCdirect.dat <- behavData %>%
  filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
  mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
  group_by(Subject, Group, SwitchCount, Procedure.Trial.) %>%
  summarise(RT = mean(respTime)) %>%
  spread(SwitchCount, RT) %>%
  mutate(SwitchCosts = Switch-Rep)
SCdirect.stat <- aov_ez(
  data = SCdirect.dat,
  dv = "SwitchCosts",
  id = "Subject", 
  within = c("Procedure.Trial."),
  between = "Group"
)
SCdirect.res <- apa_print(SCdirect.stat)
SCdirect.grp.fup <- apa_print(pairs(emmeans(SCdirect.stat, ~Procedure.Trial.|Group)))
SCdirect.tsk.fup <- apa_print(pairs(emmeans(SCdirect.stat, ~Group|Procedure.Trial.)))
colSch.SC <- apa_print(t.test(SCdirect.dat$SwitchCosts[SCdirect.dat$Group == "Colour" & SCdirect.dat$Procedure.Trial. == "TaskC"], mu = 0, alternative = "greater"))
colCat.SC <- apa_print(t.test(SCdirect.dat$SwitchCosts[SCdirect.dat$Group == "Colour" & SCdirect.dat$Procedure.Trial. == "TaskL"], mu = 0, alternative = "greater"))
shpSch.SC <- apa_print(t.test(SCdirect.dat$SwitchCosts[SCdirect.dat$Group == "Shape" & SCdirect.dat$Procedure.Trial. == "TaskC"], mu = 0, alternative = "greater"))
shpCat.SC <- apa_print(t.test(SCdirect.dat$SwitchCosts[SCdirect.dat$Group == "Shape" & SCdirect.dat$Procedure.Trial. == "TaskL"], mu = 0, alternative = "greater"))
```

```{r}
#We performed a 2x2 ANOVA in order to evaluate the effect of task transition (repeat vs switch) and Group (shape vs colour) on the response times to the categorisation task displays. The results showed no significant main effect of Group (`r learnSC.res$full_result$Group`) , however there was a significant main effect of task transition on response times where switching tasks resulted in a significant slowing of responses to the task display (`r learnSC.res$full_result$SwitchCount`). There was also a significant interaction between group and task transition (`r learnSC.res$full_result$SwitchCount_Group`). When we follow up this interaction we see that there are significant switch costs for the colour group (`r learnSC.fup$full_result$Rep_Switch_Colour`) however we do not observe significant switch costs for participants in the shape group (`r learnSC.fup$full_result$Rep_Switch_Shape`). Switch costs for both groups in each task are shown in figure\ \@ref(fig:switchCostPlot).

#We also carried out a 2x2 ANOVA in order to evaluate the effect of task transition (repeat vs switch) and Group (shape vs colour) on the response times to the search task displays. The results showed no significant main effect of group(`r searchSC.res$full_result$Group`), however there was a significant main effect of task transition on response times where switching tasks resulted in a significant slowing of responses to the task display (`r searchSC.res$full_result$SwitchCount`). There was no significant interaction between group and task transition(`r searchSC.res$full_result$Group_SwitchCount`).
```

Switch costs were calculated by subtracting repsonse times to switch trials from response times to repetition trials. First, one sample t tests were used to show that participants in the colour group incur significant switch costs in the both the categorisation task (`r colCat.SC$full_result`) and the search task (`r colSch.SC$full_result`). Similarly, participants in the shape group show significant switch costs during both categorisation (`r shpCat.SC$full_result`) and search (`r shpSch.SC$full_result`). We then performed a 2x2 ANOVA in order to evaluate the effect of task (categorisation vs search) and group (colour vs shape) on the size of these switch costs. Our results show a significant effect of task (`r SCdirect.res$full_reuslt$Procedure_Trial_`), but not group (`r SCdirect.res$full_reuslt$Group`), however these effects are superceded by a significant interaction between taks and group (`r SCdirect.res$full_reuslt$Group_Procedure_Trial_`). Follow-up comparisons demonstrate that participants in the colour group have significantly larger switch costs when switching to the categorisation task than to the search task (`r SCdirect.grp.fup$statistic$TaskC_TaskL_Colour`), whereas participants in the shape group show no difference between tasks (`r SCdirect.grp.fup$statistic$TaskC_TaskL_Shape`). In the categorisation task, participants in the colour group have significantly larger switch costs than participants in the colour group (`r SCdirect.tsk.fup$statistic$Colour_Shape_TaskL`) however there is no difference between the two groups for the search task (`r SCdirect.tsk.fup$statistic$Colour_Shape_TaskC`).

(ref:SCPlot) Response times for switch and repeat trials for the colour group (green) and the shape group (grey) in each task. For the serach task (left) we observe a switch cost (faster responses to repetition trials) for both groups of participants. In the categorisation task (right) participants in the colour group show significant switch costs however participants in the shape group show no significant effect.

```{r switchCostPlot, fig.cap= "(ref:SCPlot)"}
switchCost.se <- behavData %>%
filter(Procedure.Trial. == "TaskC") %>%
filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
group_by(Subject, Group, SwitchCount) %>%
summarise(RT = mean(respTime)) %>%
group_by(Group, SwitchCount) %>%
summarise(se = sd(RT)/sqrt(length(unique(Subject))),RT = mean(RT))
plot1 <- behavData %>%
filter(Procedure.Trial. == "TaskC") %>%
filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
group_by(Subject, Group, SwitchCount) %>%
summarise(RT = mean(respTime)) %>%
ggplot(aes(x=SwitchCount, y=RT, fill = Group)) +
geom_point(aes(colour = Group), size = 2, alpha = 0.3) +
geom_line(aes(colour = Group, group = Subject), alpha = 0.3) +
geom_point(data = switchCost.se, aes(colour = Group),size = 5) +
geom_line(data = switchCost.se, aes(group = Group, colour = Group), size=2) +
facet_grid(.~Group) +
scale_colour_manual(values=c("green4", "gray42")) +
scale_fill_manual(values=c("green4", "gray42")) +
scale_y_continuous(limits = c(250,1100), expand = c(0, 0)) +
scale_x_discrete(limits = c("Rep", "Switch"), labels = c("Switch", "Rep")) +
labs(y = "Response time (ms)", x = "Search Task") +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black"),
#axis.title.x = element_text("Search Task"),
axis.ticks = element_blank(),
text= element_text(size=18),
strip.background = element_blank(),
legend.position = "none"
)
switchCost.se <- behavData %>%
filter(Procedure.Trial. == "TaskL") %>%
filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
group_by(Subject, Group, SwitchCount) %>%
summarise(RT = mean(respTime)) %>%
group_by(Group, SwitchCount) %>%
summarise(se = sd(RT)/sqrt(length(unique(Subject))),RT = mean(RT))
plot2 <- behavData %>%
filter(Procedure.Trial. == "TaskL") %>%
filter(switchRate > minSwitchRate,CompSearch.RT < compCutoff | LearnSearch.RT < learnCutoff) %>%
mutate(respTime = ifelse(!is.na(CompSearch.RT),CompSearch.RT,LearnSearch.RT), SwitchCount = ifelse(SwitchCount == 1, "Switch", "Rep")) %>%
group_by(Subject, Group, SwitchCount) %>%
summarise(RT = mean(respTime)) %>%
ggplot(aes(x=SwitchCount, y=RT, fill = Group)) +
geom_point(aes(colour = Group), size = 2, alpha = 0.3) +
geom_line(aes(colour = Group, group = Subject), alpha = 0.3) +
geom_point(data = switchCost.se, aes(colour = Group),size = 5) +
geom_line(data = switchCost.se, aes(group = Group, colour = Group), size=2) +
facet_grid(.~Group) +
scale_colour_manual(values=c("green4", "gray42")) +
scale_fill_manual(values=c("green4", "gray42")) +
scale_y_continuous(limits = c(250,1100), expand = c(0, 0)) +
scale_x_discrete(limits = c("Rep", "Switch"), labels = c("Switch", "Rep")) +
labs(y = "Response time (ms)", x = "Categorisation task") +
theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black"),
axis.title.y = element_text(colour = "white"),
axis.ticks = element_blank(),
text= element_text(size=18),
strip.background = element_blank(),
legend.position = "none"
)
grid.arrange(plot1,plot2, ncol = 2, nrow = 1)
```

# Discussion

Previous research has established that an individual's selection history biases their attention during visual search, even when that selection history is task irrelevant and impairs search performance. In this study, we aimed to test whether the effects of selection history on attention guidance can be eliminated in situations in which top-down control is maximised. To this end, we used a voluntary task selection design which allowed participants to decide which task they would like to perform on each trial. The results showed that selection history continues to bias attention during visual search leading to impaired target selection and an increased need for distractor suppression. These effects are reflected both in response times as increased distractor costs, and in lateralised ERP components as simultaneous attenuation of the NT component and increase of the PD component.

This pattern of results is consistent with the results of @feldmann2015you who used a version of this task which allowed for only limited top-down control. In their experiment, participants were also randomly assigned to either a colour categorisation, or shape categorisation group and asked to perform two tasks. In the categorisation task their responses depended on group assignment (categorising either the colour or shape singleton) and in the search task all participants had to search for and respond to a line within a shape singleton. In their version of the task, the two tasks were randomly intermixed and participants had no way of knowing whether the upcoming trial would be a categorisation trial or a search trial. Their results showed that colour categorisers incurred greater response time costs when a colour distractor was present in the search display relative to shape categorisers. The ERP results in their task for the most part align with ours. When search targets are presented alone, there is no difference in the NT amplitude for the two groups. However, when colour distractors are present, the NT to targets is larger in the shape group implying improved target selection, and the PD to distractors is larger in the colour group implying an increased need for distractor suppression. The fact that this pattern of results persists when voluntary task selection is used in our case, suggests that selection history is the result of an implicit accrual of information about a feature dimension's relevance that biases attention automatically.

One difference observed between the results of @feldmann2015you and our study is that they observed a negativity to distractors in the search task for participants in the colour group whereas we see no such component. A negativity to distractors, referred to as the ND, has been observed in a number of search tasks and is typically viewed as reflecting attentional selection of the distractor and therefore analogous to the NT. @feldmann2015you suggested that an ND was elicited for the colour group in response to colour distractors because their selection history in the categorisation task causes the coloured distractor to capture attention in the search task. The fact that we see no evidence of this capture in our task may suggest that the increased top-down control granted by voluntary selection allows participants to prevent this initial capture by colour distractors. An implication of our results may therefore be that top-down control can be used to prevent initial capture of distractors, but that this in itself does not prevent the need for distractor suppression (as indexed by the large PD).

The role that top-down control itself plays in directing attention is well documented...space for top-down stuff...
Prvious work has evaluated the interaction between top-down control and selective attention using versions of our task in which participants were cued about the task they would perform on the subsequent trial, or performed the tasks in a fixed, predictable order [@kadel2017selection]. In both cases, the results showed the same selection history effects reported here, suggesting that top-down preparation cannot overrule the effect that selection history has on attentional filter settings

Our study extends on previous work primarily through the use of a voluntary task selection design. Experiments from the task switching literature have provided a number of ways that top-down control can be improved in tasks like the one used here. Examples include task cuing paradigms where a cue is presented before the trial to tell participants which task they are about to perform, as well as the alternating-runs paradigm where tasks are performed in a predictable sequence for example, A-A-B-B-A-A-B-B [@kiesel2010control]. Both of these procedures allow the participant to switch tasks sets in preparation for the upcoming trial demands and have been shown to reduce the cost of a task switch as a result. Voluntary task selection is a more recent development along these lines [@arrington2004cost;@arrington2005voluntary], and ERP evidence has been used to suggest that it results in even greater preparatory reconfiguration processes than the cuing paradigms used previously [@kang2014electrophysiological;@vandamme2010voluntary]. Therefore, our results extend on the results of @kadel2017selection which showed that increased top-down control did not eliminate selection history effects, by showing that this is true even when the opportunity for top-down preparatory control is maximised.

Another advantage of the voluntary task selection design used here is that it allows us to measure choice processes. Participants are typically instructed to attempt to distribute their choices as randomly as possible, in which case the probability of switching on a given trial would be 50%. Results from voluntary task switching experiments have typically shown that participants do not produce switch rates of 50% but instead show a fairly consistent repetition bias [@arrington2005voluntary;@arrington2004cost]. Importantly, this does not appear to be a general consequence of asking people to produce random sequences, which has been shown to instead produce the opposite effect - a switching bias [@arrington2004cost;@nickerson2002production]. @arrington2004cost suggested that the repetition bias may reflect participants’ attempts to avoid the costs of a task switch, and they supported this by showing that the repetition bias is mediated by the length of time preceding a choice. When participants are given more time between trials before they have to make a choice, both switch costs and the magnitude of the repetition bias are reduced.

In our results, we see that participants in the colour group had a repetition bias indicating that they struggled to randomly select between trial types and instead were more likely to repeat the previous trial type than switch. This was different to participants in the shape group who showed no evidence of a bias in their choices. These results imply that participants who are performing shape categorisation in the categorisation task may be incurring smaller costs as a result of task switching, and therefore do not attempt to avoid task switches to the same degree as participants in the colour group. This suggestion is supported by the fact that response time costs associated with a task switch are only present in the colour group when they switch from a search trial to a categorisation trial. We see no such switch costs for those in the shape group and no significant cost for the colour group when switching from categorisation to search. The relative lack of switch costs in our task confirms that the increased top-down control afforded by the voluntary task selection procedure is allowing participants to mitigate the costs that are typically usually observed during task switching. Despite utilising the available top-down control however, participants in the colour group are still incurring some task switch costs and, presumably as a consequence of this, show a repetition bias in their choices.

An interesting feature of the switch costs described above is the asymmetry observed in the colour group. Switch costs are incurred when they switch from the search task to the categorisation task, however no cost is detected in the reverse situation where they switch from categorisation to search. This kind of switch cost asymmetry has been described in previous task switching paradigms where the two tasks differ in difficulty [@arrington2014voluntary]. Somewhat paradoxically it has been shown that switch costs tend to be larger for the easier task, and this is true for general task switching paradigms [@alport199417] as well as in various types of voluntary task selection [@yeung2010bottom;@millington2013between]. While participant accuracy in our two tasks do not differ significantly, we do see a significant slowing of responses to the search task suggesting that it may be the more diffcult of the two tasks. The observation that switch costs are present for the categorisation task but not the search task is therefore consistent with the finding that switch costs are larger for the easier task. @millington2013between suggested that this effect is caused by between-task competition in which the task set of a difficult task needs to be imposed more strongly, making it harder to suppress when switching back to the easier task.

Notably in our case, participants in the shape group are not displaying a similar switch cost asymmetry. While the categorisation task does still appear to be the easier of the tasks for this group of participants, as shown by their faster response times, switch costs are not larger for the categorisation task. This suggests that the between-task competition present in previous task switching experiments, and present in the colour group of our task, is reduced for participants in the shape group. Previous literature evaluating the effect of task difficulty on voluntary task selection has also shown that participants typically choose to perform more trials of the difficult as a consequence of this competition [@arrington2014voluntary;@yeung2010bottom;@millington2013between]. Unfortunately, we cannot observe this in our task as participants are required to perform an equal number of each task by the end of the experiment, and are given feedback after every 32 trials to encourage balanced selection. However, our results suggest that our paradigm allows for the control of task difficulty and the simultaneous manipulation of between-task competition. Future work investigating the role of between-task competition and task difficulty may therefore find utility in expanding on the paradigm described here to understand participants' bias toward selecting the difficult task during voluntary task selection.

```{r }
#The group differences that we observe in switch rates and switch costs may appear to provide an alternate explanation for the effects of selection history that were described earlier. Participants in the shape group seem to be having an easier time switching between task sets for the categorisation and the search task, presumably because of the increased overlap in task requirements. In the search task both groups must locate a shape singleton, and in the categorisation task the shape group continue to locate a shape singleton whereas the colour group must switch to locating a colour singleton. Impaired selection of the search target and increased distractor suppression by those in the colour group may therefore be attributed to an impaired activation of the current task set, rather than the accumulation of a colour-focused selection history. It is important to note however that the effect of selection history that we observe in both behaviour and ERP components is measured in response to search trials, where switch costs are absent for both groups of participants. Previous work has also shown that these effects persist when the two tasks are performed in separate sessions and therefore task switching is completely absent [@kadel2017selection]. Therefore, our results here are unlikely to be the product of group differences in the ease of task switching, and are instead attributable to the role of an individual's selection history in shifting their attention.
```

# Conclusion

Previous work has managed to establish that a person's selection history can influence their deployment of attention during the performance of a visual search task. While previous studies have attempted to understand the extent to which increased top-down control could be used to counteract this effect, our study used a voluntary task selection paradigm to maximise participants' top-down control. The results showed that top-down control could not be used to eliminate the effects of selection history on attention even when maximised. This was evident in both the distractor costs measured from behaviour, as well as lateralised ERP components which dissociate target selection and distractor suppression. We also demonstrate the role that group assignment in our task has on choice processes and switch costs that are measureable in a voluntary task switching procedure. The only switch costs we observe in our task are for the categorisation task in the colour group which, along with the repetition bias present only in the colour group, suggests increased between-task competition for those participants. These results support the suggestion by @awh2012top that selection history represents a third distinct mechanism of attention control, and future research into visual attention would benefit from clarifying the mechanism by which this information is accrued.

```{r}
#First half task choice vs second half? MNaybe in the first half we see something more like free choice and therefore get a difficult task bias as expected by Yeung 2010 and millington, poljac, Yeung 2013
```

```{r, differentMorphologyOfComponentsInCategorisation}
#One notable feature of the ERP in our tasks is the wide shallow nature of the lateralised positivity during the categorisation task, particularly in the case of a lateralised colour singleton. Whereas the lateralised responses evoked in the search task reflect the features of typical NT/PD components, the lateralised response in the categorisation task showed significant overlap in the time ranges of the NT and PD, and a broadly distributed positivty in the case of lateralised colour singletons. We also observe a possible lateralised positivty to the target stimulus (colour singleton for the colour group, and shape singleton for the shape group) which follows the initial NT response.
```

```{r, previousExamplesOfSelectionHistoryAndPostulatedMechanisms}
#Several studies showed that when specific stimulus features or dimensions are reliable
#predictors of an outcome, they induce an attentional bias in favor of these stimuli (e.g., Le
#Pelley, Suret, & Beesley, 2009; Le Pelley et al., 2013; Mitchell & Le Pelley, 2010).
#Moreover, stimuli previously shown to be predictive for a specific outcome are more rapidly
#learned about subsequently (learned predictiveness effect; Le Pelley & McLaren, 2003). Both
#deliberate attentional selection as well as automatic attentional capture are influenced by
#learned predictiveness (Le Pelley, Mitchell, Beesley, George, & Wills, 2016). There are two
#explanatory approaches (see Pinto, Vogel, & Núñez, 2017): associative interpretations and
#propositional interpretations. According to the associative approach, a link between
#representations of a stimulus and the representation of an outcome is formed in a relatively
#automatic way and without much cognitive control. In contrast, the propositional approach
#(e.g., Mitchell, De Houwer, & Lovibond, 2009) assumes that predictive learning is based on
#effortful higher-order cognitive processes. Most likely, both associative and propositional
#influences play a role (Pinto et al., 2017). 
```

# References
